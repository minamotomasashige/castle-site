<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10. äºŒæœ¬æ¾åŸ æ—…è¨˜éŒ²</title>
    <style>
        /* ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã¨å†™çœŸã‚¨ãƒªã‚¢ã®åŸºæœ¬ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .content-section {
            width: 80%; /* ãƒšãƒ¼ã‚¸ã®å¹…ã‚’èª¿æ•´ */
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px; /* è§’ã‚’å°‘ã—ä¸¸ã */
        }
        
        /* ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        textarea {
            width: 100%;
            min-height: 150px; /* é«˜ã•ã®æœ€ä½å€¤ã‚’è¨­å®š */
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* paddingã‚’å«ã‚ãŸã‚µã‚¤ã‚ºè¨ˆç®— */
            font-size: 16px;
            resize: vertical; /* ç¸¦æ–¹å‘ã®ã¿ãƒªã‚µã‚¤ã‚ºå¯èƒ½ */
        }

        /* å†™çœŸé…ç½®ã‚¨ãƒªã‚¢ã®æ ï¼ˆã“ã ã‚ã‚Šã®ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰ */
        .photo-area {
            display: flex; /* å†™çœŸã‚’æ¨ªã«ä¸¦ã¹ã‚‹ãŸã‚ã«ä½¿ã†ï¼ˆå¾Œã§èª¬æ˜ï¼‰ */
            gap: 20px; /* å†™çœŸã¨å†™çœŸã®é–“éš” */
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9; /* è–„ã„èƒŒæ™¯è‰² */
            border: 1px dashed #aaa; /* ç‚¹ç·šã®æ  */
            border-radius: 12px;
        }

        /* å®Ÿéš›ã«é…ç½®ã™ã‚‹å†™çœŸã®æ ï¼ˆæ­£æ–¹å½¢ã«ãƒˆãƒªãƒŸãƒ³ã‚°ã•ã‚Œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ */
        .photo-frame {
            width: 200px;
            height: 200px;
            border: 5px solid #fff; /* å†™çœŸã®å‘¨ã‚Šã«ç™½ã„å¤ªæ  */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* å½±ã‚’ã¤ã‘ã¦ç«‹ä½“çš„ã« */
            overflow: hidden; /* æ ã‹ã‚‰ã¯ã¿å‡ºãŸéƒ¨åˆ†ã‚’éè¡¨ç¤º */
        }

        /* å†™çœŸãã®ã‚‚ã®ã®è¨­å®š */
        .photo-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* å†™çœŸã‚’æ ã«åˆã‚ã›ã¦ãƒˆãƒªãƒŸãƒ³ã‚°ï¼ˆé‡è¦ï¼‰ */
            display: block;
        }
    /* æ–°ã—ã„CSSã‚’<style>ã‚¿ã‚°ã«è¿½åŠ  */

/* å†™çœŸã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã²ã¨ã¾ã¨ã‚ã«ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.photo-group {
    display: flex; /* ã‚°ãƒ«ãƒ¼ãƒ—å†…ã¯ç¸¦ã«ä¸¦ã¶ï¼ˆflex-direction: column; ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */
    flex-direction: column; 
    align-items: center; /* å†™çœŸã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¸­å¤®æƒãˆ */
    width: 200px; /* å†™çœŸæ ã®å¹…ã«åˆã‚ã›ã‚‹ */
}

/* å€‹åˆ¥ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
.photo-comment {
    width: 100%; /* photo-groupã®å¹…ã„ã£ã±ã„ã«åºƒã’ã‚‹ */
    height: 60px; /* é«˜ã•ã‚’ä½ã‚ã«è¨­å®š */
    margin-top: 10px;
    padding: 5px;
    font-size: 13px;
    resize: none; /* ãƒªã‚µã‚¤ã‚ºã§ããªã„ã‚ˆã†ã«å›ºå®š */
}
/* æ—¢å­˜ã®CSSï¼ˆtableè¦ç´ ï¼‰ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«èª¿æ•´ */
table {
    border-collapse: collapse;
    width: 95%; /* ç”»é¢å¹…ã®95%ã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´ */
    max-width: 600px; /* PCãªã©åºƒã„ç”»é¢ã§ã¯æœ€å¤§600pxã«åˆ¶é™ */
    margin: 20px auto;
    font-size: 14px; /* ã‚¹ãƒãƒ›ã§è¦‹ã‚„ã™ã„ã‚ˆã†ã«å°‘ã—æ–‡å­—ã‚’å°ã•ã */
}
/* --- CSSã‚³ãƒ¼ãƒ‰ã®è¿½åŠ ï¼ˆ<style>ã‚¿ã‚°å†…ã€ä¸€ç•ªä¸‹ã¸ï¼‰ --- */

/* 7. å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.delete-photo-btn {
    background-color: #dc3545; /* èµ¤è‰² */
    color: white;
    border: none;
    padding: 5px 10px;
    font-size: 12px;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 10px;
    margin-bottom: 10px; /* ä»–ã®è¦ç´ ã¨ã®é–“ã«éš™é–“ã‚’ä½œã‚‹ */
    transition: background-color 0.2s; /* ãƒ›ãƒãƒ¼æ™‚ã®å¤‰åŒ–ã‚’æ»‘ã‚‰ã‹ã« */
}

.delete-photo-btn:hover {
    background-color: #c82333;
}
    </style>
</head>
<body>

    <div class="content-section">
        <h1>4. äºŒæœ¬æ¾åŸ è©³ç´°æƒ…å ±</h1>
        <p><a href="/castle-site/touhoku_list.html">åŸä¸€è¦§ã¸æˆ»ã‚‹</a></p>
    </div>

    <div class="content-section">
        <h2>è¨ªå•è¨˜éŒ²ãƒ»ãƒ¡ãƒ¢</h2>
        <textarea id="my-notes" placeholder="ã“ã“ã«è¨ªå•ã—ãŸæ—¥ä»˜ã‚„æ„Ÿæƒ³ã€ãƒ¡ãƒ¢ãªã©ã‚’è‡ªç”±ã«æ›¸ãè¾¼ã‚“ã§ãã ã•ã„ã€‚"></textarea>
        </div>

    <div class="content-section">
    <h2>ğŸ“· è¨ªå•å†™çœŸã¨å€‹åˆ¥ãƒ¡ãƒ¢</h2>
    <div class="photo-area" id="photo-area-4"> <input type="file" id="photo-upload-4" accept="image/*" style="display: none;">
        <button onclick="document.getElementById('photo-upload-4').click()">
            å†™çœŸã‚’ã‚¢ãƒ«ãƒãƒ ã‹ã‚‰è¿½åŠ 
        </button>

        </div>
</div>

       
        </div>
</div>
<script>
    // å®šæ•°å®šç¾© (åŸã”ã¨ã«å¤‰ã‚ã‚‹IDã¯ '4' ã®éƒ¨åˆ†ã®ã¿)
    const CASTLE_ID = '4'; // â˜…å¼˜å‰åŸãªã®ã§ã€Œ4ã€â˜…
    const NOTES_KEY = 'castleGeneralNotes_'; 
    const PHOTO_KEY = 'castle_photos_';
    const PHOTO_COMMENT_KEY = 'castlePhotoComments_';

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', function() {
        // 1. ä¸€èˆ¬ãƒ¡ãƒ¢ã®å¾©å…ƒã¨ä¿å­˜ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        loadGeneralNotes(CASTLE_ID);
        document.getElementById('general-notes-' + CASTLE_ID).addEventListener('input', saveGeneralNotes);

        // 2. å†™çœŸã¨å€‹åˆ¥ãƒ¡ãƒ¢ã®å¾©å…ƒã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        loadStoredPhotos(CASTLE_ID); 
        const fileInput = document.getElementById('photo-upload-' + CASTLE_ID);
        if (fileInput) {
            fileInput.addEventListener('change', handleImageUpload);
        }
    });
    
    // =========================================================
    // 1. ä¸€èˆ¬ãƒ¡ãƒ¢ã®ä¿å­˜ãƒ»å¾©å…ƒ
    // =========================================================

    /* ä¸€èˆ¬ãƒ¡ãƒ¢ã‚’LocalStorageã«ä¿å­˜ */
    function saveGeneralNotes() {
        const key = NOTES_KEY + CASTLE_ID;
        const content = document.getElementById('general-notes-' + CASTLE_ID).value;
        localStorage.setItem(key, content);
    }

    /* ä¸€èˆ¬ãƒ¡ãƒ¢ã‚’LocalStorageã‹ã‚‰å¾©å…ƒ */
    function loadGeneralNotes(castleId) {
        const key = NOTES_KEY + castleId;
        const savedContent = localStorage.getItem(key);
        if (savedContent) {
            document.getElementById('general-notes-' + castleId).value = savedContent;
        }
    }


    // =========================================================
    // 2. å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»ä¿å­˜ãƒ»è¡¨ç¤º
    // =========================================================

    /* å†™çœŸãŒé¸æŠã•ã‚ŒãŸã¨ãã®å‡¦ç† */
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const base64Image = e.target.result;
            // å†™çœŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã€ãƒšãƒ¼ã‚¸ã«è¡¨ç¤º
            savePhotoToLocalStorage(CASTLE_ID, base64Image);
            displayNewPhoto(CASTLE_ID, { data: base64Image, timestamp: Date.now() });
        };
        reader.readAsDataURL(file);
        event.target.value = ''; // åŒã˜å†™çœŸã‚’å†åº¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
    }

    /* Base64ç”»åƒã‚’LocalStorageã«ä¿å­˜ */
    function savePhotoToLocalStorage(castleId, base64Image) {
        const key = PHOTO_KEY + castleId;
        let storedPhotos = localStorage.getItem(key);
        let photoArray = storedPhotos ? JSON.parse(storedPhotos) : [];

        photoArray.push({
            data: base64Image,
            timestamp: Date.now() // ãƒ¦ãƒ‹ãƒ¼ã‚¯IDã¨ã—ã¦ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä¿å­˜
        });

        localStorage.setItem(key, JSON.stringify(photoArray));
    }

    /* ä¿å­˜ã•ã‚ŒãŸå†™çœŸã‚’ãƒšãƒ¼ã‚¸ã«è¡¨ç¤º */
    function displayNewPhoto(castleId, photoData) {
        const photoArea = document.getElementById('photo-area-' + castleId);
        if (!photoArea) return;
        
        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã¨ã—ã¦ä½¿ç”¨ (æ–°è¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ or å¾©å…ƒ)
        const timestamp = photoData.timestamp || Date.now(); 
        const base64Image = photoData.data || photoData; // å¾©å…ƒæ™‚ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€æ–°è¦æ™‚ã¯æ–‡å­—åˆ—

        // HTMLè¦ç´ ã‚’ä½œæˆ (photo-group, photo-frame, img)
        const photoGroup = document.createElement('div');
        photoGroup.classList.add('photo-group');
        const photoFrame = document.createElement('div');
        photoFrame.classList.add('photo-frame');
        const img = document.createElement('img');
        img.src = base64Image;
        img.alt = 'è¨ªå•å†™çœŸ';
        photoFrame.appendChild(img);
        photoGroup.appendChild(photoFrame);

        // å€‹åˆ¥ã‚³ãƒ¡ãƒ³ãƒˆæ ã‚’ä½œæˆ
        const textarea = document.createElement('textarea');
        textarea.classList.add('photo-comment');
        textarea.id = 'comment_' + castleId + '_' + timestamp; 
        textarea.placeholder = "ã“ã®å†™çœŸã«é–¢ã™ã‚‹ãƒ¡ãƒ¢";
        
        // ãƒ¡ãƒ¢ä¿å­˜ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
        textarea.addEventListener('input', savePhotoComment); 
        photoGroup.appendChild(textarea);
        
        // â˜…â˜…â˜… å‰Šé™¤ãƒœã‚¿ãƒ³ã®ä½œæˆã¨è¿½åŠ  â˜…â˜…â˜…
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'å†™çœŸã‚’å‰Šé™¤';
        deleteButton.classList.add('delete-photo-btn');
        deleteButton.setAttribute('data-timestamp', timestamp); 
        
        deleteButton.onclick = function() {
            deletePhoto(this, castleId, timestamp);
        };
        photoGroup.appendChild(deleteButton); 
        // â˜…â˜…â˜… å‰Šé™¤ãƒœã‚¿ãƒ³ã®ä½œæˆã¨è¿½åŠ  çµ‚ã‚ã‚Š â˜…â˜…â˜…

        // å†™çœŸã‚¨ãƒªã‚¢ã®ã€Œå†™çœŸè¿½åŠ ãƒœã‚¿ãƒ³ã€ã®ç›´å‰ã«è¿½åŠ 
        const button = photoArea.querySelector('button');
        photoArea.insertBefore(photoGroup, button);

        // å¾©å…ƒå‡¦ç†ã®å ´åˆã€ãƒ¡ãƒ¢ã‚‚åŒæ™‚ã«ãƒ­ãƒ¼ãƒ‰
        if (photoData.data) {
             loadSinglePhotoComment(textarea.id);
        }
    }

    /* ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¿å­˜ã•ã‚ŒãŸå†™çœŸã‚’å…¨ã¦å¾©å…ƒ */
    function loadStoredPhotos(castleId) {
        const key = PHOTO_KEY + castleId;
        const storedPhotos = localStorage.getItem(key);
        if (!storedPhotos) return;

        const photoArray = JSON.parse(storedPhotos);
        photoArray.forEach(photoData => {
            // å†™çœŸãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã—ã€displayNewPhotoå†…ã§ãƒ¡ãƒ¢ã‚‚å¾©å…ƒ
            displayNewPhoto(castleId, photoData); 
        });
    }

    // =========================================================
    // 3. å€‹åˆ¥ãƒ¡ãƒ¢ã®ä¿å­˜ãƒ»å¾©å…ƒ
    // =========================================================
    
    /* å€‹åˆ¥ãƒ¡ãƒ¢ã‚’LocalStorageã«ä¿å­˜ã™ã‚‹å‡¦ç† */
    function savePhotoComment(event) {
        const textarea = event.target;
        const key = PHOTO_COMMENT_KEY + CASTLE_ID; // CASTLE_IDã‚’å‚ç…§
        const commentId = textarea.id; 
        const content = textarea.value;

        let storedComments = localStorage.getItem(key);
        let comments = storedComments ? JSON.parse(storedComments) : {};

        comments[commentId] = content;
        localStorage.setItem(key, JSON.stringify(comments));
    }

    /* å€‹åˆ¥ãƒ¡ãƒ¢ã‚’LocalStorageã‹ã‚‰å¾©å…ƒ (displayNewPhotoã‹ã‚‰å‘¼ã°ã‚Œã‚‹) */
    function loadSinglePhotoComment(commentId) {
        const key = PHOTO_COMMENT_KEY + CASTLE_ID; // CASTLE_IDã‚’å‚ç…§
        const storedComments = localStorage.getItem(key);
        if (!storedComments) return;

        const comments = JSON.parse(storedComments);
        const textarea = document.getElementById(commentId);
        
        if (textarea && comments[commentId] !== undefined) {
            textarea.value = comments[commentId];
        }
    }
    
    // =========================================================
    // 4. å†™çœŸãƒ»ãƒ¡ãƒ¢å‰Šé™¤æ©Ÿèƒ½
    // =========================================================

    /* å†™çœŸã¨å€‹åˆ¥ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã™ã‚‹å‡¦ç† */
    function deletePhoto(buttonElement, castleId, timestamp) {
        if (!confirm('ã“ã®å†™çœŸã¨ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
            return;
        }

        // 1. LocalStorageã‹ã‚‰å†™çœŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
        const photoKey = PHOTO_KEY + castleId;
        let storedPhotos = localStorage.getItem(photoKey);
        let photoArray = storedPhotos ? JSON.parse(storedPhotos) : [];

        const newPhotoArray = photoArray.filter(item => item.timestamp !== timestamp);
        localStorage.setItem(photoKey, JSON.stringify(newPhotoArray));

        // 2. LocalStorageã‹ã‚‰å€‹åˆ¥ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
        const commentKey = PHOTO_COMMENT_KEY + castleId;
        let storedComments = localStorage.getItem(commentKey);
        let comments = storedComments ? JSON.parse(storedComments) : {};
        
        const commentId = 'comment_' + castleId + '_' + timestamp;
        delete comments[commentId]; 
        localStorage.setItem(commentKey, JSON.stringify(comments));

        // 3. ç”»é¢ä¸Šã®è¦ç´ ã‚’å‰Šé™¤
        const photoGroup = buttonElement.closest('.photo-group');
        if (photoGroup) {
            photoGroup.remove();
        }
    }
</script>
</body>

</html>